---
title: "What is a good way to measure the dispersion of growth curves?"
authors: "Justin Patterson, Elsa Beda"
output: pdf_document
---

```{r}
library("ggplot2")
library("mlegp")
```


```{r}
get_exp_data_with_error = function(max_t, b_0, b_1, b_2, e_0_extremeness, e_1_extremeness, e_2_extremeness) {
    # The model is y = (b_0 + e_0) + (b_1 + e_1)*exp((b_2 + e_2)*t)
    # where e_0, e_1 and e_2 are errors.
    # e_0_extremeness, e_1_extremeness & e_2_extremeness should be non-negative
    # with higher values indicating more extremeness.
    #
    # Returns y values.
    
    # R is 1-indexed. :(
    y = vector(mode = "numeric", length = max_t + 1)
    
    # It's some proportion of b_0
    sd_0 = e_0_extremeness * abs(b_0)
    e_0 = rnorm(n = max_t + 1, mean = 0, sd = sd_0)

    # Start large and decrease.
    # The part with (- e_1_extremeness * abs(b_1) / max_t)
    # is like the slope.
    sd_1 = e_1_extremeness * abs(b_1) + (- e_1_extremeness * abs(b_1) / max_t) * seq(0, max_t, 1)
    e_1 = rnorm(n = max_t + 1, mean = 0, sd = sd_1)

    sd_2 = e_2_extremeness * abs(b_2)
    e_2 = rnorm(n = max_t + 1, mean = 0, sd = sd_2)

    # y[1] means the y-value when t == 0.
    y[1] = round(b_0 + e_0[1] + b_1 + e_1[1])
    for (t in seq(2, max_t + 1, 1)) {
        y[t] = round((b_0 + e_0[t]) + (y[t - 1] - (b_0 + e_0[t]))*exp(b_2 + e_2[t]))
    }

    return(y)
}
```

```{r}
drop_cols_with_negs = function(X) {
    # Args:
    #   X: matrix
    # Returns:
    #   matrix with positive entries by
    #   dropping columns from X
    return(X[ , -(which(X <= 0, arr.ind = TRUE)[ , 2])])
}
```

```{r}
get_growth_data = function(
    num_curves,
    max_t, 
    b_0, 
    b_1, 
    b_2,
    e_0_extremeness,
    e_1_extremeness, 
    e_2_extremeness
) {
    # Call get_exp_data_with_error.
    g = replicate(
        n = num_curves,
        expr = get_exp_data_with_error(
            max_t = max_t, 
            b_0 = b_0, 
            b_1 = b_1, 
            b_2 = b_2,
            e_0_extremeness = e_0_extremeness,
            e_1_extremeness = e_1_extremeness, 
            e_2_extremeness = e_2_extremeness
        )
    )
    
    # Check for extinctions.
    pos_g = drop_cols_with_negs(X = g)

    return(pos_g)
}
```

```{r}
max_t = 100
# Number of growth curves
NUM_REPLICATES_1 = 10

# Args for function call
num_curves = NUM_REPLICATES_1
b_0 = 500
b_1 = 100
b_2 = 0.09
e_0_extremeness = 0.9
e_1_extremeness = 0.2
e_2_extremeness = 0.9

try_1 = get_growth_data(
    num_curves = num_curves,
    max_t = max_t, 
    b_0 = b_0, 
    b_1 = b_1, 
    b_2 = b_2,
    e_0_extremeness = e_0_extremeness,
    e_1_extremeness = e_1_extremeness, 
    e_2_extremeness = e_2_extremeness
)
```

```{r}
get_pooled_variance_of_log_response = function(X) {
    # X: matrix
    #   The columns of X represent independent realizations
    #   of the same univariate stochastic process.
    #   Values in the same row of X have the same value
    #   of the index t for the stochastic process.
    #
    # The values in X are transformed via the log
    # function.  Next, the sample variances of the values
    # in each column of X are computed.
    # The arithmetic mean of these variances is returned.
    # https://en.wikipedia.org/wiki/Pooled_variance#Definition_and_computation
    # This is a pooling because there are uniform sample sizes 
    # of the number of rows in X.
    return(1 / NROW(X) * sum(apply(X = log(X), MARGIN = 1, FUN = var)))
}
```

```{r}
get_pooled_variance_of_log_response(try_1)
```

Use a GP regression to estimate the variance at each time point.

```{r}
design_matrix = matrix(data = seq(0, NROW(try_1) - 1, 1), nrow = NROW(try_1), ncol = 1, byrow = FALSE)
try_1_mlegp = mlegp(X = design_matrix, Z = log(try_1))
```


```{r}
plot(try_1_mlegp)
```

```{r}
print(x = try_1_mlegp, nums = 1)
```

```{r}
g = try_1
g_data = data.frame(
    replicate_num = rep(seq_len(NCOL(g)), each = NROW(g)),
    year = rep(seq(0, NROW(g) - 1), times = NCOL(g)),
    log_pop_size = log(as.vector(g))
)
```

```{r}
fig = ggplot(
    data = g_data,
    mapping = aes(
        x = year,
        y = exp(log_pop_size),
        color = as.factor(replicate_num)
    )
) 

fig = fig + 
    geom_line() +
    labs(title = "Samples from the Same Stochastic Process", color = "Replicate")

fig

```


```{r}
png(filename = file.path("/home/justin/Documents/schoolwork/ISYE_6413_Design_of_Exp/doe_group_project/data/exp_growth.png"))
print(fig)
dev.off()
```